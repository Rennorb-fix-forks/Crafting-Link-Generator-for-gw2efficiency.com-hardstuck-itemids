// ==UserScript==
// @name        Metabattle Crafting Link Generator for gw2efficiency.com
// @version     1.02
// @author      Felodin
// @description Generates a link with the desired format and opens it in a new window
// @match     https://metabattle.com/wiki/Build:*
// @grant       none
// ==/UserScript==


(function() {
    'use strict';

    // Add a button to the page
    const button = document.createElement('button');
    button.innerHTML = 'Generate crafting link for gw2efficiency.com';
    button.style.cssText = 'margin: 10px;';
    button.style.position = "fixed";
    button.style.top = "10%";
    button.style.left = "50%";
    button.style.transform = "translate(-50%, -50%)";
    button.style.zIndex = "9999";
    document.body.appendChild(button);

    // Add an event listener to the button that generates the link and opens it in a new window when clicked
    button.addEventListener('click', function() {
        // Get all the divs with the data-armory-ids attribute that are inside the divs with the ids "eq-box-1", "eq-box-2", "eq-box-3" and the class "equipment-slot-exo" and "equipment-slot-inf"
        const divs = document.querySelectorAll('#eq-box-1 div[data-armory-ids], #eq-box-2 div[data-armory-ids], #eq-box-3 div[data-armory-ids], .equipment-slot div[data-armory-ids]');

        // Create an object to store the <ammount>-<itemid> pairs and their counts
        const pairs = {};

        // Loop through the divs and extract the <ammount>-<itemid> pairs
        divs.forEach(function(div) {
            const ids = div.getAttribute('data-armory-ids').split(',');
            ids.forEach(function(id) {
                // Skip the divs with data-armory-ids="-1"
                if (id.trim() === "-1") {
                    return;
                }
                const pair = `${div.textContent.trim()}-${id.trim()}`;
                // If the pair is already in the object, increment its count by 1
                if (pair in pairs) {
                    pairs[pair]++;
                } else {
                    // Otherwise, add the pair to the object with a count of 1
                    pairs[pair] = 1;
                }
            });
        });

        // Convert the pairs object into an array of strings in the format "<ammount>x<itemid>"
        const pairsArray = [];
        for (const pair in pairs) {
            pairsArray.push(`${pairs[pair]}x${pair}`);
        }

        // Join the pairs array into a string and add it to the end of the link
        const link = `https://gw2efficiency.com/crafting/calculator/a~0!b~0!c~0!d~${pairsArray.join(';')}`;

        // Open the link in a new window
        window.open(link, '_blank');
    });
})();
